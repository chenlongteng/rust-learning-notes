# 闭包

## 捕获变量
闭包可以使用属于其所在函数的数据。  
`借用值的闭包` 创建闭包时，会自动借入对变量的引用，并保存在栈上。  
`“窃取”值的闭包`   move || -> T {}，闭包前加move，表示将变量移动到闭包中，取得它们的所有权。例如thread::spawn创建线程时移动所在函数的变量，避免不安全共享。

## 函数与闭包的类型
**函数类型**  
如：`fn(&City) -> i64` 类型表示该函数接受一个参数&City并返回i64。  

**闭包类型**  
每个闭包都有一个自己的特殊类型，可以大到容纳借用和窃取的值。任何两个闭包类型都不相同  
但是闭包都实现了Fn特征，如Fn(&City) -> i64既可以接受上面的函数类型也可以介绍满足这个特征的闭包

## 闭包性能
大多数语言中，闭包会在堆中分配内存、进行动态派发以及垃圾回收。因此，创建、调用和收集每一个闭包都会花费一点点额外的CPU时间。并且闭包往往难以内联。  
Rust中，除非将闭包放在Box、Vec或其他容器中，否则不会被分配到堆上。又由于每个闭包类型不同，Rust只要直到你正在调用的闭包类型，就可以内联该闭包代码。  
注意：闭包并不包含指向其代码的指针，没有用。

## 闭包与安全
闭包会从周围借用或移动变量，如果在闭包中丢弃或修改其捕获的值时会发生什么？  
`FnOnce` Rust不允许多次调用会丢弃值的闭包。即会丢弃的闭包不允许实现Fn特征，而是一种FnOnce特征，只能调用一次闭包的特征。
`FnMut` 一种包含可变数据或可变引用的闭包。任何需要对值进行可变访问但不会丢弃任何值的闭包都是FnMut闭包。

### 3种类型的闭包
`Fn` 是可以不受限制地调用任意多次的闭包和函数系列。此最高类别还包括所有fn函数  
`FnMut` 是本身会被声明为mut，并且可以多次调用的闭包系列  
`FnOnce` 是如果其调用者拥有此闭包，它就只能调用一次的闭包系列  

Fn是FnMut的子特征，FnMut是FnOnce的子特征。  

### 对闭包的Copy与Clone
闭包可以表示为包含它们捕获的变量的值（对于move闭包）或对值的引用（对于非move闭包）的结构体。闭包的Copy规则和Clone规则和常规结构提是一样的。  
1. 一个不修改变量的非move闭包只持有不可变引用时，这些引用既能Clone也能Copy，所以闭包也能Clone和Copy。  
2. 一个会修改值的非move闭包在其内部表示中也可以有可变引用。可变引用即不能Clone，也不能Copy，使用它们的闭包同样如此。
3. 对于move闭包，规则更简单。如果move闭包捕获的所有内容都能Copy，那它就能Copy。如果move闭包所捕获的所有内容都能Clone，那它就能Clone。
